name: Deploy to OKE

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Permite rodar manualmente

jobs:
  deploy-hk:
    runs-on: ubuntu-latest
    environment: hk  # Usa os secrets específicos do ambiente 'hk'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OCI CLI and Configure kubectl MANUALLY
        run: |
          # 1. Instala OCI CLI
          bash -c "$(curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh)" -- --accept-all-defaults
          export PATH="$HOME/bin:$PATH"

          # 2. Cria a chave privada a partir do secret
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_CLI_KEY_CONTENT }}" > ~/.oci/key.pem
          chmod 600 ~/.oci/key.pem

          # 3. Cria o arquivo de configuração OCI
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_CLI_USER }}
          fingerprint=${{ secrets.OCI_CLI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_CLI_TENANCY }}
          region=${{ secrets.OCI_CLI_REGION }}
          key_file=~/.oci/key.pem
          EOF

          # 4. Gera o arquivo kubeconfig para o cluster
          #    ATENÇÃO: Use '--token-version 2.0.0' e '--auth instance_principal' se aplicável
          $HOME/bin/oci ce cluster create-kubeconfig \
            --cluster-id ${{ secrets.OKE_CLUSTER_OCID }} \
            --file $HOME/.kube/config \
            --region ${{ secrets.OCI_CLI_REGION }} \
            --token-version 2.0.0

          # 5. Testa a conexão
          kubectl get nodes
        with:
          cluster-id: ${{ secrets.OKE_CLUSTER_OCID }}
        env:
          OCI_CLI_USER: ${{ secrets.OCI_CLI_USER }}
          OCI_CLI_TENANCY: ${{ secrets.OCI_CLI_TENANCY }}
          OCI_CLI_FINGERPRINT: ${{ secrets.OCI_CLI_FINGERPRINT }}
          OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_CLI_KEY_CONTENT }}
          OCI_CLI_REGION: ${{ secrets.OCI_CLI_REGION }}

      - name: Login to OCIR
        run: |
          echo "${{ secrets.OCIR_PASSWORD_HK }}" | docker login ${{ secrets.OCIR_REGISTRY }} -u "${{ secrets.OCIR_USERNAME }}" --password-stdin

      - name: Build and push Docker image
        run: |
          docker build -t ${{ secrets.OCIR_REGISTRY }}/grwmqw3g1ezq/minibanco-oracle:latest .
          docker push ${{ secrets.OCIR_REGISTRY }}/grwmqw3g1ezq/minibanco-oracle:latest

      - name: Deploy ALL manifests to HK namespace
        run: |
          kubectl apply -f k8s/hk/
          kubectl rollout status deployment/java-app -n hk

  deploy-prod:
    runs-on: ubuntu-latest
    environment: prod  # Usa os secrets específicos do ambiente 'prod'
    needs: deploy-hk   # Só roda depois que HK terminar
    if: github.event_name == 'workflow_dispatch'  # SOMENTE MANUAL

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure OCI CLI and kubectl for OKE
        uses: oracle-actions/configure-kubectl-oke@v1
        with:
          cluster-id: ${{ secrets.OKE_CLUSTER_OCID }}
        env:
          OCI_CLI_USER: ${{ secrets.OCI_CLI_USER }}
          OCI_CLI_TENANCY: ${{ secrets.OCI_CLI_TENANCY }}
          OCI_CLI_FINGERPRINT: ${{ secrets.OCI_CLI_FINGERPRINT }}
          OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_CLI_KEY_CONTENT }}
          OCI_CLI_REGION: ${{ secrets.OCI_CLI_REGION }}

      - name: Deploy ALL manifests to PROD namespace
        run: |
          kubectl apply -f k8s/prod/
          kubectl rollout status deployment/java-app -n prod